DEBIAN_FRONTEND=noninteractive apt install -y --no-install-recommends build-essential cmake git libjson-c-dev libwebsockets-dev ssh openssl openssh-server curl wget sudo tzdata keyboard-configuration maven gcc g++ openjdk-8-jdk libjson-c-dev cmake libwebsockets-dev build-essential make libavcodec-dev libavutil-dev libavformat-dev libwebsockets-dev git libtelnet-dev libpango1.0-dev libswscale-dev libpulse-dev libvorbis-dev libwebp-dev libssl-dev libssh2-1-dev freerdp2-dev libvncserver-dev libossp-uuid-dev libtool-bin libpng-dev libjpeg-turbo8-dev libcairo2-dev build-essential 
yes "" | ssh-keygen &
wget https://downloads.apache.org/tomcat/tomcat-9/v9.0.65/bin/apache-tomcat-9.0.65.tar.gz &&  mkdir /opt/tomcat && sudo tar -xzf apache-tomcat-9.0.65.tar.gz -C /opt/tomcat/ && rm apache-tomcat-9.0.65.tar.gz && mv /opt/tomcat/apache-tomcat-9.0.65 /opt/tomcat/tomcatapp && chmod +x /opt/tomcat/tomcatapp
rm -rf  /opt/tomcat/tomcatapp/webapps
mkdir -p /opt/tomcat/tomcatapp/webapps/ROOT && cd /opt/tomcat/tomcatapp/webapps/ROOT && wget https://downloads.apache.org/guacamole/1.4.0/binary/guacamole-1.4.0.war  && jar -xvf *.war  
mkdir -p /etc/guacamole/{extensions,lib}
cd /etc/guacamole
wget https://downloads.apache.org/guacamole/1.4.0/source/guacamole-server-1.4.0.tar.gz
tar xf guacamole-server-1.4.0.tar.gz
rm guacamole-server-1.4.0.tar.gz
cd guacamole-server-1.4.0
export CFLAGS="-Wno-error" 
./configure --with-init-dir=/etc/init.d
echo "running make"
make 
make install
ldconfig
cd /etc/guacamole
wget https://raw.githubusercontent.com/amitstudydude/RDP_Linux/main/guacamole.properties
wget https://raw.githubusercontent.com/amitstudydude/RDP_Linux/main/user-mapping.xml 
wget https://raw.githubusercontent.com/amitstudydude/RDP_Linux/main/guacd.conf   
wget https://downloads.apache.org/guacamole/1.4.0/binary/guacamole-1.4.0.war 
sed -i 's/localhost/172.17.0.1/g' /etc/guacamole/user-mapping.xml 
ln -s /etc/guacamole/guacamole.war /opt/tomcat/tomcatapp/webapps
echo "GUACAMOLE_HOME=/etc/guacamole" | sudo tee -a /etc/default/tomcat
echo "export GUACAMOLE_HOME=/etc/guacamole" | sudo tee -a /etc/profile
ln -s /etc/guacamole /opt/tomcat/tomcatapp/.guacamole
sudo systemctl daemon-reload
service ssh restart && sed -i '3 i PasswordAuthentication yes' /etc/ssh/sshd_config && sed -i '3 i PermitUserEnvironment yes' /etc/ssh/sshd_config && sed -i '3 i PermitRootLogin yes' /etc/ssh/sshd_config && service ssh restart
cat >/script.sh <<EOF
service guacd restart
/etc/init.d/guacd restart
/etc/init.d/guacd status
/opt/tomcat/tomcatapp/bin/catalina.sh run 
EOF

chmod +x /script.sh
mv /script.sh /usr/bin/script.sh

